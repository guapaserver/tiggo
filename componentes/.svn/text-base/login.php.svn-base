<?php
	ob_start(); 
	session_name("user");
	session_start("user");
	ini_set('display_errors', E_ALL);

	if(!$_SESSION["idioma"])
	{
		$_SESSION["idioma"] = "br";
	}

	include ("inc/includes.php");

	$o_ilustra = new Ilustra;
	$o_ajudante = new Ajudante;
	$o_configuracao = new Configuracao;
	$o_usuario = new Usuario;
	$o_auditoria = new Auditoria;

	$url_fisico = $o_configuracao->url_fisico();
	$url_virtual = $o_configuracao->url_virtual();
	
	switch($_REQUEST['acao'])
	{
		case 'logar':

			//trata dados do usurio
			$email = $_POST['_email'];
			$senha = htmlspecialchars($o_ajudante->trata_input($_POST['_senha']));
		
			if(!(empty($email) AND ($senha)))
			{
				//busca usurio cuso tipo  igual aos dados enviados e tipo = 1 (administrador)
				$o_usuario->set('email',$email);
				$o_usuario->set('senha',$senha);
				//$o_usuario->set('estado','a');
		
				if($rs = $o_usuario->selecionar_usuario_pessoa())
				{
					//usurio existe - registra as informaes na sesso
					foreach($rs as $linha)
					{
						$_SESSION["usuario_numero"] = $linha["usuario_id"];
						$_SESSION["usuario_usuario"] = $linha["usuario_nome"];
						$_SESSION["usuario_tipo_id"] = $linha["id"];
						$_SESSION["usuario_cidade"] = $linha["cidade"];
						$_SESSION["usuario_uf"] = $linha["uf"];
						$_SESSION["usuario_email"] = $linha["usuario_email"];
						$_SESSION["usuario_adm_tipo"] = $linha["tipo_nome"];
						$_SESSION["usuario_data_hora"] = $linha["data_acesso"];
						$_SESSION["acesso"] = "sim";
					}
			
					//insere todas permisses em varivel de sesso
					$o_usuario_ambiente = new Usuario_ambiente;
					$o_usuario_ambiente->set('id_usuario_tipo',$_SESSION["usuario_tipo_id"]);
					if($rs = $o_usuario_ambiente->selecionar())
					{
						foreach($rs as $l)
						{
							$grupo_ambientes[] = $l['id_ambiente'];
						}
					}
					$_SESSION['grupo_ambientes'] = $grupo_ambientes;
			
					//print_r($_SESSION['grupo_ambientes']);
					
					$o_auditoria->set('acao_descricao',"Acessou o sistema.");
					$o_auditoria->inserir();
					
					//$fancy = "$(document).ready(function (){fancy_function('".$url_virtual."componentes/popup_galeria.php',700,675,'iframe')});";
					
					header("Location: ".$url_virtual."galeria_virtual/formulario");
				}
				else
				{
					$msg = "Usurio ou senha incorretos!";
					//exit();
				}
			}
			else
			{
				$msg =  "Favor digitar corretamente usurio e senha.";
			}
			
		break;
		
		case 'sair':
		
			$o_usuario->set('data_acesso',date("Y/m/d H:i:s"));
			$o_usuario->set('id',$_SESSION["usuario_numero"]);
	
			$rs = $o_usuario->editar_data_acesso();
	
			$o_auditoria->set('acao_descricao',"Saiu do sistema: ".$_SESSION["usuario_numero"].".");
			$o_auditoria->inserir();
	
			$_SESSION = array(); //limpa as variveis de sesso
			session_destroy();
	
			header("Location: ".$url_virtual."");
			ob_end_flush();
			
		break;
	}

	//inicializa o template para administrar as pginas
	$template = $o_ajudante->template("".$url_fisico."templates/login.html");

	//troca as variveis
	$array = array(
		"[url_virtual]" => $url_virtual,
		"[acao]" => $url_virtual."login",
		//"[fancy]" => $fancy,
		"[msg]" => $msg
	);

	$conteudo = strtr($template,$array);
	unset($array);
	
	$corpo_html = $conteudo;

	unset($o_configuracao);
	unset($o_ajudante);
	unset($o_auditoria);
	unset($o_usuario);
?>